
<!DOCTYPE html>
<html>
<body>
<meta charset="utf-8">

<div class="toc">
<ul>
<li><a href="#installing-rabbitmq">Installing RabbitMQ</a></li>
<li><a href="#configuring-rabbitmq">Configuring RabbitMQ</a><ul>
<li><a href="#keys-and-certificates">Keys and Certificates</a></li>
<li><a href="#email-the-server-certificate-to-alice-and-bob">Email the server certificate to Alice and Bob</a></li>
<li><a href="#enabling-ssl-support-in-rabbitmq">Enabling SSL Support in RabbitMQ</a></li>
<li><a href="#opening-the-port">Opening the port</a></li>
</ul>
</li>
<li><a href="#registering-users">Registering users</a></li>
<li><a href="#web-console">Web console</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
</div>

<h1 id="installing-rabbitmq">Installing RabbitMQ</h1>
<p>On Debian:</p>
<pre><code>aptitude install rabbitmq-server
</code></pre>
<p>It will install and start immediately. To stop it, type:</p>
<pre><code>/etc/init.d/rabbitmq-server stop
</code></pre>
<p>First of all, let us change the default user's password. The default user is called <code>guest</code>.
To change the password, first have to start the server:</p>
<pre><code>/etc/init.d/rabbitmq-server start
</code></pre>
<p>and then say:</p>
<pre><code>rabbitmqctl change_password guest VGIWB0CEWwDW
</code></pre>
<p>where <code>VGIWB0CEWwDW</code> is the new password. </p>
<h1 id="configuring-rabbitmq">Configuring RabbitMQ</h1>
<h2 id="keys-and-certificates">Keys and Certificates</h2>
<p>There is a very good guide on the <a href="http://www.rabbitmq.com/ssl.html">RabbitMQ website</a>, just follow the 
instructions in the section called "Keys, Certificates and CA Certificates". You do not need the
client part, <strong>only the server part</strong>. </p>
<p>The only thing I have to add to those instructions, is the following.  The RabbitMQ server runs under the user <code>rabbitmq</code>
(which was  automatically created by the <code>aptitude</code> when you installed RabbitMQ).
All these files which you created
in <code>testca/</code> and <code>server/</code> should be <strong>readable</strong> by the <code>rabbitmq</code> user:</p>
<pre><code>chown -R root:rabbitmq testca server
</code></pre>
<p>and set the 750 permission:</p>
<pre><code>drwxr-x--- 2 root rabbitmq 4.0K Aug 20 15:11 client
drwxr-x--- 2 root rabbitmq 4.0K Aug 20 15:02 server
drwxr-x--- 4 root rabbitmq 4.0K Aug 20 15:11 testca
</code></pre>
<p>On my server, I created <code>/var/rabbitmq</code> and put both <code>testca/</code> and <code>server/</code> as its subdirectories, so I have:</p>
<pre><code>/var/rabbitmq/testca/
/var/rabbitmq/server/
</code></pre>
<h2 id="email-the-server-certificate-to-alice-and-bob">Email the server certificate to Alice and Bob</h2>
<p>The folder <code>server/</code> contains a file <code>cert.pem</code> which you should send to all users (by email).</p>
<h2 id="enabling-ssl-support-in-rabbitmq">Enabling SSL Support in RabbitMQ</h2>
<p>This, again, is explained on the <a href="http://www.rabbitmq.com/ssl.html">RabbitMQ website</a>, in the section
called "Enabling SSL Support in RabbitMQ". Basically, all you have to do is (as root):</p>
<p>```
echo '[
  {rabbit, [
     {ssl_listeners, [5671]},
     {ssl_options, [{cacertfile,"/path/to/testca/cacert.pem"},
                    {certfile,"/path/to/server/cert.pem"},
                    {keyfile,"/path/to/server/key.pem"},
                    {verify,verify_peer},
                    {fail_if_no_peer_cert,false}]}
   ]}
].' &gt;&gt;    /etc/rabbitmq/rabbitmq.config</p>
<p>```</p>
<p><strong>and then replace</strong> <code>/path/to/testca</code> and <code>/path/to/server</code> with the path to those two directories which you
created in the previous subsection, when setting up keys.</p>
<h2 id="opening-the-port">Opening the port</h2>
<p>As you have noticed, we have configured the SSL-enabled RabbitMQ to listen on Port 5671.
Obviously, we have to open that port:</p>
<pre><code>iptables -A INPUT -p tcp --dport 5671 -j ACCEPT
/etc/init.d/iptables-persistent save
</code></pre>
<h1 id="registering-users">Registering users</h1>
<p>To add user <code>alice</code>:</p>
<pre><code>rabbitmqctl add_user alice sarrpuOSX1Nm
rabbitmqctl set_permissions alice ".*" ".*" ".*"
</code></pre>
<p>where <code>sarrpuOSX1Nm</code> is her password.</p>
<p>This should be repeated for each user.</p>
<h1 id="web-console">Web console</h1>
<p>I want one of the users to be the administrator for the purpose of Web Console
management. Let it be Alice:</p>
<pre><code>rabbitmqctl set_user_tags alice administrator
</code></pre>
<p>Then I want to enable the Web Console plugin:</p>
<pre><code>rabbitmq-plugins enable rabbitmq_management
</code></pre>
<p>Moreover, I want to run the Web Console under SSL. For that, I have to edit the file <code>/etc/rabbitmq/rabbitmq.conf</code>
to contain the following lines:</p>
<pre><code>[
  {rabbit, [
     {ssl_listeners, [5671]},
     {ssl_options, [{cacertfile,"/var/rabbitmq/testca/cacert.pem"},
                    {certfile,"/var/rabbitmq/server/cert.pem"},
                    {keyfile,"/var/rabbitmq/server/key.pem"},
                    {verify,verify_peer},
                    {fail_if_no_peer_cert,false}]}
   ]},
  {rabbitmq_management, 
        [ 
                {http_log_dir, "/tmp/rabbit-mgmt"},
                {listener, [
                        {port, 15672}, 
                        {ssl, true},
                        {ssl_opts, [{cacertfile,"/var/rabbitmq/testca/cacert.pem"},
                                    {certfile,"/var/rabbitmq/server/cert.pem"},
                                    {keyfile,"/var/rabbitmq/server/key.pem"}
                                   ]}
                           ]}
        ]}
].
</code></pre>
<h1 id="troubleshooting">Troubleshooting</h1>
<p>Log files are in <code>/var/log/rabbitmq</code></p>

</html>
</body>

